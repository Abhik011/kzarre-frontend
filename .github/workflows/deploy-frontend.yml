#!/bin/bash
set -e

SOURCE_DIR="/home/ec2-user/kzarre-frontend"
BLUE_DIR="/home/ec2-user/kzarre-frontend-blue"
GREEN_DIR="/home/ec2-user/kzarre-frontend-green"

BLUE_PORT=3000
GREEN_PORT=3001

BLUE_NAME="kzarre-frontend-blue"
GREEN_NAME="kzarre-frontend-green"

echo "ğŸ”„ Pulling latest frontend code..."
cd $SOURCE_DIR
git pull

echo "ğŸ“¦ Installing dependencies..."
npm install

echo "ğŸ—ï¸ Building Next.js..."
npm run build

# Identify target
if pm2 describe $BLUE_NAME > /dev/null 2>&1; then
    TARGET=$GREEN_NAME
    TARGET_DIR=$GREEN_DIR
    PORT=$GREEN_PORT
else
    TARGET=$BLUE_NAME
    TARGET_DIR=$BLUE_DIR
    PORT=$BLUE_PORT
fi

echo "ğŸ—‚ï¸ Copying build to $TARGET_DIR"
rm -rf $TARGET_DIR/*
cp -R $SOURCE_DIR/.next $TARGET_DIR/
cp -R $SOURCE_DIR/public $TARGET_DIR/
cp $SOURCE_DIR/package.json $TARGET_DIR/

cd $TARGET_DIR

echo "ğŸš€ Starting frontend ($TARGET) on port $PORT..."
pm2 start "npm start" --name $TARGET -- --port=$PORT || pm2 restart $TARGET -- --port=$PORT

echo "â³ Waiting for frontend to boot..."
sleep 5

echo "ğŸ©º Checking health..."
if curl -fs http://127.0.0.1:$PORT/ > /dev/null; then
    echo "âœ… Frontend healthy! Switching upstream..."
    bash /home/ec2-user/switch-blue-green.sh frontend $PORT
else
    echo "âŒ Frontend failed health check!"
    exit 1
fi

echo "ğŸ’¾ Saving PM2 state..."
pm2 save
